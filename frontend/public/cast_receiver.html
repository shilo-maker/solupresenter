<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SoluCast Receiver</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      overflow: hidden;
    }
    #iframe-container {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
  <!-- Cast Receiver SDK -->
  <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
</head>
<body>
  <div id="iframe-container">
    <iframe id="viewer-frame" src="" allow="autoplay"></iframe>
  </div>

  <!-- Invisible video to prevent screensaver -->
  <video id="screensaver-prevention" loop muted autoplay playsinline style="position: absolute; width: 1px; height: 1px; opacity: 0.01; pointer-events: none; z-index: -1;">
    <source src="data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAr9tZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE1MiByMjg1NCBlOWE1OTAzIC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxNyAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTEgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdGhyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJfcHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBkaXJlY3Q9MSB3ZWlnaHRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTIga2V5aW50PTI1MCBrZXlpbnRfbWluPTEgc2NlbmVjdXQ9NDAgaW50cmFfcmVmcmVzaD0wIHJjX2xvb2thaGVhZD00MCByYz1jcmYgbWJ0cmVlPTEgY3JmPTIzLjAgcWNvbXA9MC42MCBxcG1pbj0wIHFwbWF4PTY5IHFwc3RlcD00IGlwX3JhdGlvPTEuNDAgYXE9MToxLjAwAIAAAAAwZYiEACD/2lu4PtiAGCZiIJmO35BneLS4/AKawbwF3gS81VgCN/Hreo0IAAADAAADAAAGBsZYgAg//X2NXAAACglBmiRsQT/+1gAAAAkBnkJ5Cf8AAAYIAAAACQJ5DqQp/AAAA" type="video/mp4">
  </video>

  <script>
    console.log('üöÄ Receiver starting...');

    // Global error handler to prevent crashes
    window.addEventListener('error', (event) => {
      console.error(`‚ùå Window error: ${event.error?.message || event.message}`);
      console.error('Window error:', event.error);
      // Don't let errors crash the receiver
      event.preventDefault();
      return true;
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error(`‚ùå Promise rejection: ${event.reason}`);
      console.error('Unhandled promise rejection:', event.reason);
      event.preventDefault();
      return true;
    });

    console.log('üì° Initializing Cast SDK...');
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();
    console.log('‚úÖ Cast SDK initialized');

    // Ensure screensaver prevention video is playing
    const preventScreensaver = () => {
      const video = document.getElementById('screensaver-prevention');
      if (video) {
        video.play().catch(e => {
          console.error(`‚ö†Ô∏è Video play failed: ${e.message}`);
        });
      }
    };

    console.log('üëÇ Setting up message listener...');
    // Listen for custom messages from sender
    context.addCustomMessageListener('urn:x-cast:com.solucast.viewer', (customEvent) => {
      console.log('üì® Received message from sender');
      const data = customEvent.data;
      console.log(`Message type: ${data.type}`);

      if (data.type === 'LOAD_VIEWER') {
        // Load the viewer page in the iframe
        const viewerUrl = data.url;
        console.log(`üì∫ Loading viewer URL: ${viewerUrl}`);

        const iframe = document.getElementById('viewer-frame');
        iframe.src = viewerUrl;

        // Add iframe load event listeners
        iframe.onload = () => {
          console.log('‚úÖ Iframe loaded successfully');

          // Try to listen for errors from iframe
          try {
            iframe.contentWindow.addEventListener('error', (e) => {
              console.error(`‚ùå Iframe JS error: ${e.message}`);
            });
            iframe.contentWindow.addEventListener('unhandledrejection', (e) => {
              console.error(`‚ùå Iframe Promise rejection: ${e.reason}`);
            });
            console.log('üëÇ Listening for iframe errors');
          } catch (e) {
            console.error(`‚ö†Ô∏è Cannot listen to iframe errors: ${e.message}`);
          }
        };

        iframe.onerror = (e) => {
          console.error(`‚ùå Iframe error: ${e.message || 'Unknown error'}`);
        };

        // Set the iframe source
        iframe.src = viewerUrl;
        console.log('‚è≥ Iframe src set, waiting for load...');

        // Start screensaver prevention
        setTimeout(() => {
          preventScreensaver();
          console.log('üé• Screensaver prevention started');
        }, 1000);
      }
    });

    // Keepalive mechanism - prevent Chromecast from disconnecting
    // Also ensure video keeps playing every 5 seconds
    let keepaliveCount = 0;
    setInterval(() => {
      try {
        keepaliveCount++;
        // Touch the context to keep it alive
        context.setApplicationState('SoluCast Active');
        // Ensure video is still playing
        preventScreensaver();

        // Log every 12th keepalive (once per minute)
        if (keepaliveCount % 12 === 0) {
          console.log('üíì Keepalive ping');
        }
      } catch (e) {
        console.error(`‚ùå Keepalive error: ${e.message}`);
      }
    }, 5000);

    // Start the receiver
    console.log('üé¨ Starting receiver with options...');
    const options = new cast.framework.CastReceiverOptions();
    options.disableIdleTimeout = true; // Disable idle timeout
    options.maxInactivity = 3600; // Keep alive for 1 hour of inactivity

    try {
      context.start(options);
      console.log('‚úÖ Receiver started successfully!');
      console.log('‚è≥ Waiting for connection from sender...');
    } catch (e) {
      console.error(`‚ùå Failed to start receiver: ${e.message}`);
      console.error('Failed to start receiver:', e);
    }
  </script>
</body>
</html>
