<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SoluCast Receiver</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      overflow: hidden;
    }
    #iframe-container {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    #debug-overlay {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.95);
      color: #0f0;
      padding: 20px;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 9999;
      border: 2px solid #0f0;
      border-radius: 5px;
      word-wrap: break-word;
      word-break: break-word;
      /* Stays visible - no auto-hide */
    }
    #debug-overlay .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-bottom: 1px solid #333;
    }
    #debug-overlay .log-entry.error {
      color: #f00;
    }
    #debug-overlay .log-entry.success {
      color: #0f0;
    }
    #debug-overlay .log-entry.info {
      color: #ff0;
    }
  </style>
  <!-- Cast Receiver SDK -->
  <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
</head>
<body>
  <!-- Debug overlay -->
  <div id="debug-overlay">
    <h3>üîç SoluCast Debug Console</h3>
    <div id="debug-logs"></div>
  </div>

  <div id="iframe-container">
    <iframe id="viewer-frame" src="" allow="autoplay"></iframe>
  </div>

  <!-- Invisible video to prevent screensaver - TEMPORARILY DISABLED FOR TESTING -->
  <!-- <video id="screensaver-prevention" loop muted autoplay playsinline>
    <source src="data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAr9tZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE1MiByMjg1NCBlOWE1OTAzIC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxNyAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTEgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdGhyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJfcHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBkaXJlY3Q9MSB3ZWlnaHRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTIga2V5aW50PTI1MCBrZXlpbnRfbWluPTEgc2NlbmVjdXQ9NDAgaW50cmFfcmVmcmVzaD0wIHJjX2xvb2thaGVhZD00MCByYz1jcmYgbWJ0cmVlPTEgY3JmPTIzLjAgcWNvbXA9MC42MCBxcG1pbj0wIHFwbWF4PTY5IHFwc3RlcD00IGlwX3JhdGlvPTEuNDAgYXE9MToxLjAwAIAAAAAwZYiEACD/2lu4PtiAGCZiIJmO35BneLS4/AKawbwF3gS81VgCN/Hreo0IAAADAAADAAAGBsZYgAg//X2NXAAACglBmiRsQT/+1gAAAAkBnkJ5Cf8AAAYIAAAACQJ5DqQp/AAAA" type="video/mp4">
  </video> -->

  <script>
    // Debug logging function
    const debugLog = (message, type = 'info') => {
      const timestamp = new Date().toLocaleTimeString();
      const logContainer = document.getElementById('debug-logs');
      const debugOverlay = document.getElementById('debug-overlay');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${timestamp}] ${message}`;
      logContainer.appendChild(entry);

      // Don't limit entries - keep all logs for debugging
      // while (logContainer.children.length > 20) {
      //   logContainer.removeChild(logContainer.firstChild);
      // }

      // Auto-scroll to bottom of the debug overlay
      setTimeout(() => {
        if (debugOverlay) {
          debugOverlay.scrollTop = debugOverlay.scrollHeight;
        }
      }, 0);

      // Also log to console
      console.log(`[${type.toUpperCase()}] ${message}`);
    };

    debugLog('üöÄ Receiver starting...', 'info');

    // Global error handler to prevent crashes
    window.addEventListener('error', (event) => {
      debugLog(`‚ùå Window error: ${event.error?.message || event.message}`, 'error');
      console.error('Window error:', event.error);
      // Don't let errors crash the receiver
      event.preventDefault();
      return true;
    });

    window.addEventListener('unhandledrejection', (event) => {
      debugLog(`‚ùå Promise rejection: ${event.reason}`, 'error');
      console.error('Unhandled promise rejection:', event.reason);
      event.preventDefault();
      return true;
    });

    debugLog('üì° Initializing Cast SDK...', 'info');
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();
    debugLog('‚úÖ Cast SDK initialized', 'success');

    // Ensure screensaver prevention video is playing
    const preventScreensaver = () => {
      const video = document.getElementById('screensaver-prevention');
      if (video) {
        video.play().catch(e => {
          debugLog(`‚ö†Ô∏è Video play failed: ${e.message}`, 'error');
        });
      }
    };

    debugLog('üëÇ Setting up message listener...', 'info');
    // Listen for custom messages from sender
    context.addCustomMessageListener('urn:x-cast:com.solucast.viewer', (customEvent) => {
      debugLog('üì® Received message from sender', 'info');
      const data = customEvent.data;
      debugLog(`Message type: ${data.type}`, 'info');

      if (data.type === 'LOAD_VIEWER') {
        // Load the viewer page in the iframe
        const viewerUrl = data.url;
        debugLog(`üì∫ Loading viewer URL: ${viewerUrl}`, 'success');

        const iframe = document.getElementById('viewer-frame');

        // Add iframe load event listeners
        iframe.onload = () => {
          debugLog('‚úÖ Iframe loaded successfully', 'success');

          // Try to listen for errors from iframe
          try {
            iframe.contentWindow.addEventListener('error', (e) => {
              debugLog(`‚ùå Iframe JS error: ${e.message}`, 'error');
            });
            iframe.contentWindow.addEventListener('unhandledrejection', (e) => {
              debugLog(`‚ùå Iframe Promise rejection: ${e.reason}`, 'error');
            });
            debugLog('üëÇ Listening for iframe errors', 'info');
          } catch (e) {
            debugLog(`‚ö†Ô∏è Cannot listen to iframe errors: ${e.message}`, 'error');
          }
        };

        iframe.onerror = (e) => {
          debugLog(`‚ùå Iframe error: ${e.message || 'Unknown error'}`, 'error');
        };

        // Set the iframe source
        iframe.src = viewerUrl;
        debugLog('‚è≥ Iframe src set, waiting for load...', 'info');

        // Log iframe dimensions and position
        setTimeout(() => {
          const rect = iframe.getBoundingClientRect();
          debugLog(`üìê Iframe position: ${rect.x}, ${rect.y}`, 'info');
          debugLog(`üìê Iframe size: ${rect.width}x${rect.height}`, 'info');
          debugLog(`üìê Iframe visibility: ${window.getComputedStyle(iframe).visibility}`, 'info');
          debugLog(`üìê Iframe opacity: ${window.getComputedStyle(iframe).opacity}`, 'info');
          debugLog(`üìê Iframe z-index: ${window.getComputedStyle(iframe).zIndex}`, 'info');
        }, 500);

        // Start screensaver prevention - DISABLED FOR TESTING
        // setTimeout(() => {
        //   preventScreensaver();
        //   debugLog('üé• Screensaver prevention started', 'success');
        // }, 1000);

        // Check iframe content after 3 seconds
        setTimeout(() => {
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (iframeDoc) {
              debugLog(`üìÑ Iframe has document, readyState: ${iframeDoc.readyState}`, 'info');
              debugLog(`üìÑ Iframe body exists: ${!!iframeDoc.body}`, 'info');
            } else {
              debugLog('‚ö†Ô∏è Cannot access iframe document (CORS?)', 'error');
            }
          } catch (e) {
            debugLog(`‚ö†Ô∏è Cannot check iframe: ${e.message}`, 'error');
          }
        }, 3000);

        // Check if React has loaded after 5 seconds
        setTimeout(() => {
          debugLog('üîç Checking if ViewerPage loaded...', 'info');
          debugLog('‚ö†Ô∏è If you don\'t see ViewerPage messages above, React didn\'t load!', 'error');
        }, 5000);

        // Check if iframe is actually visible on screen
        setTimeout(() => {
          const container = document.getElementById('iframe-container');
          const containerRect = container.getBoundingClientRect();
          debugLog(`üì¶ Container position: ${containerRect.x}, ${containerRect.y}`, 'info');
          debugLog(`üì¶ Container size: ${containerRect.width}x${containerRect.height}`, 'info');
          debugLog(`üì¶ Container z-index: ${window.getComputedStyle(container).zIndex}`, 'info');
        }, 3500);
      }
    });

    // Keepalive mechanism - prevent Chromecast from disconnecting
    // Also ensure video keeps playing every 5 seconds
    let keepaliveCount = 0;
    setInterval(() => {
      try {
        keepaliveCount++;
        // Touch the context to keep it alive
        context.setApplicationState('SoluCast Active');
        // Ensure video is still playing
        preventScreensaver();

        // Log every 12th keepalive (once per minute)
        if (keepaliveCount % 12 === 0) {
          debugLog('üíì Keepalive ping', 'info');
        }
      } catch (e) {
        debugLog(`‚ùå Keepalive error: ${e.message}`, 'error');
      }
    }, 5000);

    // Start the receiver
    debugLog('üé¨ Starting receiver with options...', 'info');
    const options = new cast.framework.CastReceiverOptions();
    options.disableIdleTimeout = true; // Disable idle timeout
    options.maxInactivity = 3600; // Keep alive for 1 hour of inactivity

    try {
      context.start(options);
      debugLog('‚úÖ Receiver started successfully!', 'success');
      debugLog('‚è≥ Waiting for connection from sender...', 'info');
    } catch (e) {
      debugLog(`‚ùå Failed to start receiver: ${e.message}`, 'error');
      console.error('Failed to start receiver:', e);
    }
  </script>
</body>
</html>
